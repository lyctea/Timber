var a=Object.defineProperty;var h=(t,o,e)=>o in t?a(t,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[o]=e;var r=(t,o,e)=>(h(t,typeof o!="symbol"?o+"":o,e),e);(function(){"use strict";const BASE_CDN_PATH="https://www.xtool.com/cdn/shop/t/380/assets/",loadMap=new Set;class LoadWebComponentAsset{constructor(config){r(this,"config");r(this,"errorInfo",{});r(this,"importSupports",!0);try{eval('import("").catch(err => {});')}catch(t){this.importSupports=!1}this.config={version:{},prefix:["mkt-","plugin-"],exclude:[],preload:[]},this.mergeConfig(config),this.observer(document.documentElement),this.handleComponentLoad(document.body),this.preload()}mergeConfig(t){for(const o in t){const e=o,s=t[e];s!==void 0&&(Array.isArray(s)&&Array.isArray(this.config[e])?this.config[e]=this.config[e].concat(s):this.config[e]=s)}}preload(){this.config.preload?.forEach(t=>{const{shouldLoad:o}=this.shouldLoad(t);o&&this.loadAsset(t)})}observer(t){new MutationObserver(e=>{for(const{addedNodes:s}of e)Array.from(s).forEach(i=>{i.nodeType===Node.ELEMENT_NODE&&this.handleComponentLoad(i)})}).observe(t,{subtree:!0,childList:!0})}handleComponentLoad(t){this.getAllWebComponents(t.outerHTML).reduce((s,i)=>{const{isComponent:n,shouldLoad:c}=this.shouldLoad(i);return n&&this.listenerComponent(t,i),c&&s.push(i),s},[]).forEach(s=>this.loadAsset(s))}getAllWebComponents(t){const o=/<([a-z]+-[a-z-]+)[\s\S]*?>/gi,e=t.matchAll(o);return Array.from(e,i=>i[1])}shouldLoad(t){const o=this.config.prefix.some(s=>t.startsWith(s));let e=!1;if(!loadMap.has(t)){const s=this.config.exclude.includes(t);e=!customElements.get(t)&&!s&&o,loadMap.add(t)}return{isComponent:o,shouldLoad:e}}listenerComponent(t,o){let e;if(t.tagName.toLowerCase()===o?e=t:e=t.querySelector(o),e){const s=e.shadowRoot||e.attachShadow({mode:"open"});this.observer(s)}}loadAsset(t){this.importSupports?this.importAsset(t):this.getAsset(t)}getComponentPath(t,o){let e="latest";return o||(e=this.config.version[t]||"latest"),`${BASE_CDN_PATH}${t}@${e}.js`}isLatestAsset(t){return t.endsWith("@latest.js")}getAsset(t,o){const e=this.getComponentPath(t,o);this.fetchAsset(e).catch(s=>{throw s==="Failed to fetch dynamically module"&&(this.isLatestAsset(e)?this.scriptLoadAsset(t):this.getAsset(t,!0)),s})}importLoadFailed(t){const o=["failed to fetch dynamically imported module","importing a module script failed","error loading dynamically imported module","failed to load","network error","failed"],e=t.toLowerCase();return o.some(s=>e.includes(s))}importAsset(t,o){const e=this.getComponentPath(t,o);import(e).catch(s=>{if(this.importLoadFailed(s.message))this.isLatestAsset(e)?this.getAsset(t):this.importAsset(t,!0);else{const i=JSON.stringify({message:s?.message,stack:s?.stack});this.feishuNotify({errorTitle:"mkt组件执行报错",errorLevel:2,feishuBot:"https://open.feishu.cn/open-apis/bot/v2/hook/62f3c8fd-312d-4f9f-9b95-14686b0fef8e",errorResolvePage:"https://makeblock.feishu.cn/wiki/RXzOwpcYGiI4mPklO9HcjO0anFg",errorMsg:`
            component: ${t}
            errorInfo: ${i}
          `})}throw s})}fetchAsset(url){return fetch(url).then(t=>!t.ok&&t.status===404?Promise.reject("Failed to fetch dynamically module"):t).then(t=>t.text()).then(scriptText=>{eval(scriptText)})}scriptLoadAsset(t,o){const e=this.getComponentPath(t,o),s=document.createElement("script");s.type="text/javascript",s.src=e,s.onerror=()=>{this.isLatestAsset(e)?this.scriptLoadFail(e):this.scriptLoadAsset(t,!0)},document.body.appendChild(s)}scriptLoadFail(t){this.errorInfo={assetURL:t,level:1,message:"组件资源加载失败"},this.feishuNotify({errorTitle:"mkt组件加载异常",errorLevel:1,feishuBot:"https://open.feishu.cn/open-apis/bot/v2/hook/4781e716-bc79-48cf-8469-0c8eb35afae2",errorResolvePage:"https://makeblock.feishu.cn/wiki/RXzOwpcYGiI4mPklO9HcjO0anFg",errorMsg:`
        time: ${new Date}
        message: ${this.errorInfo.message}
        assetURL: ${this.errorInfo.assetURL}
      `})}feishuNotify(t){const o=window?.__Xtool_Utils?.feishuNotification;o(t)}}function componentAutoLoader(t={}){document.addEventListener("DOMContentLoaded",()=>{new LoadWebComponentAsset(t)})}window.componentAutoLoader=componentAutoLoader})();
